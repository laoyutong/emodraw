var tt=Object.defineProperty,nt=Object.defineProperties;var rt=Object.getOwnPropertyDescriptors;var ze=Object.getOwnPropertySymbols;var st=Object.prototype.hasOwnProperty,ot=Object.prototype.propertyIsEnumerable;var pe=(e,t,r)=>t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,N=(e,t)=>{for(var r in t||(t={}))st.call(t,r)&&pe(e,r,t[r]);if(ze)for(var r of ze(t))ot.call(t,r)&&pe(e,r,t[r]);return e},ne=(e,t)=>nt(e,rt(t));var _e=(e,t,r)=>(pe(e,typeof t!="symbol"?t+"":t,r),r),ge=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var re=(e,t,r)=>(ge(e,t,"read from private field"),r?r.call(e):t.get(e)),ye=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},Oe=(e,t,r,s)=>(ge(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r);var Ce=(e,t,r)=>(ge(e,t,"access private method"),r);import{C as it,R as at,a as ct,D as lt,F as dt,A as ut,m as ht,j as se,c as we,b as M,r as w,n as oe,d as ft,L as pt,E as gt,e as yt,f as wt,g as mt,h as xt}from"./vendor.8922c5b7.js";const Dt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}};Dt();const Pe={theme:"outline",size:"20",fill:"#333"},me=[{type:"selection",Icon:it},{type:"rectangle",Icon:at},{type:"circle",Icon:ct},{type:"diamond",Icon:lt},{type:"text",Icon:dt},{type:"arrow",Icon:ut}],xe="emodraw",Ne="Segoe UI Emoji",k=15,De=k+3,Tt="#fff",v={default:"default",crosshair:"crosshair",move:"move",grab:"grab",neswResize:"nesw-resize",nwseResize:"nwse-resize"},Et=30,X=3,B=8,St=[15,10],ie=10,ke=20,ae=30,Rt="emodraw.png",bt="emodraw",ce=["rectangle","circle","diamond"],J=(e,t,r,s,n)=>{e.beginPath(),e.moveTo(t,r),e.lineTo(t+s,r),e.lineTo(t+s,r+n),e.lineTo(t,r+n),e.closePath(),e.stroke()},Lt=(e,t,r,s,n)=>{e.save(),e.fillStyle="rgba(255,165,0,0.5)",e.fillRect(t,r,s,n),e.restore()},vt=(e,t,r,s,n)=>{const o=s>n?1/s:1/n;e.beginPath(),e.moveTo(t+s,r);for(let a=0;a<Math.PI*2;a+=o)e.lineTo(t+s*Math.cos(a),r+n*Math.sin(a));e.closePath(),e.stroke()},It=(e,t,r,s,n)=>{e.beginPath(),e.moveTo(t+s/2,r+n),e.lineTo(t+s,r+n/2),e.lineTo(t+s/2,r),e.lineTo(t,r+n/2),e.closePath(),e.stroke()},At=(e,t)=>Math.floor(180/(Math.PI/Math.atan(e/t))),Xe=30,Mt=(e,t,r,s,n)=>{const o=Math.min(Math.pow(s*s+n*n,1/2)/2,Et),a=n<0?-o:o,f=At(s,n),i=f+Xe,g=f-Xe,x=t+s,T=r+n,D=x-a*Math.sin(Math.PI*i/180),A=T-a*Math.cos(Math.PI*i/180),I=x-a*Math.sin(Math.PI*g/180),G=T-a*Math.cos(Math.PI*g/180);e.beginPath(),e.moveTo(t,r),e.lineTo(x,T),e.lineTo(D,A),e.moveTo(x,T),e.lineTo(I,G),e.stroke()},zt=(e,t)=>{const{type:r,x:s,y:n,width:o,height:a}=t;switch(r){case"rectangle":J(e,s,n,o,a);return;case"circle":vt(e,s+o/2,n+a/2,Math.abs(o/2),Math.abs(a/2));return;case"arrow":Mt(e,s,n,o,a);return;case"diamond":It(e,s,n,o,a);return;case"selection":Lt(e,s,n,o,a);return}},_t=(e,t)=>{const{content:r,x:s,y:n,containerId:o,width:a}=t;e.textBaseline="bottom",e.font=`${k}px  ${Ne}`,be(r).forEach((i,g)=>{if(o){const x=e.measureText(i).width;e.fillText(i,s+(a-x)/2,n+k*(g+1))}else e.fillText(i,s,n+k*(g+1))})},Ye=(e,{x:t,y:r,width:s,height:n,type:o},a)=>{const f=s>0?X:-X,i=n>0?X:-X,g=t-f,x=t+s+f,T=r-i,D=r+n+i;if(e.setLineDash(St),e.beginPath(),e.moveTo(g,T),e.lineTo(x,T),e.lineTo(x,D),e.lineTo(g,D),e.closePath(),e.stroke(),e.setLineDash([]),!a){const A=s>0?B:-B,I=n>0?B:-B;o!=="text"&&(J(e,g,T,-A,-I),J(e,x,D,A,I),o!=="arrow"&&(J(e,x,T,A,-I),J(e,g,D,-A,I)))}},Ot=e=>{const t=c.getSelectionData();if(!t)return;const[r,s,n,o]=t;Ye(e,{x:r,y:n,width:s-r,height:o-n,type:"selection"},!1)},Te=(e,t=c.data)=>{let r=!1;c.data.filter(n=>n.isSelected).length>1&&(Ot(e),r=!0),t.forEach(n=>{n.isSelected&&Ye(e,n,r),n.type==="text"?_t(e,n):zt(e,n)})};var F,ue,Pt;class Ct{constructor(){ye(this,ue);_e(this,"data");ye(this,F,void 0);this.data=Ce(this,ue,Pt).call(this),Oe(this,F,[])}addOperateStack(t){re(this,F).push(t)}getSelectionData(){const t=this.data.filter(r=>r.isSelected);if(t.length===1&&t[0].type==="text")return null;if(t.length===1&&t[0].type==="arrow"){const r=t[0];return[r.x,r.x+r.width,r.y,r.y+r.height,!0]}return[...Re(t),!1]}addDrawData(t){this.data.push(t)}popDrawData(){this.data.pop()}revokeDrawData(){if(re(this,F).length>0){const t=re(this,F).pop();if(t.type==="DELETE"&&this.data.push(...t.payload),t.type==="ADD"&&(this.data=this.data.filter(r=>!t.selectedIds.includes(r.id))),t.type==="MOVE"){const{x:r,y:s}=t.payload;this.data.forEach(n=>n.isSelected=!1),this.data.filter(n=>t.selectedIds.includes(n.id)).forEach(n=>{n.x-=r,n.y-=s,n.isSelected=!0})}if(t.type==="RESIZE"){const r=t.payload,s=r.map(n=>n.id);this.data=this.data.filter(n=>!s.includes(n.id)).concat(r)}t.type==="SET"&&(this.data=t.payload),this.storageDrawData()}}storageDrawData(){this.data=this.data.filter(t=>t.type!=="selection").map(t=>{if(t.type==="arrow")return t;const r=N({},t);return r.width<0&&(r.x=r.x+r.width,r.width=-r.width),r.height<0&&(r.y=r.y+r.height,r.height=-r.height),r}),localStorage.setItem(xe,JSON.stringify(this.data))}delete(){const t=[];this.data.forEach(r=>{r.isSelected&&(r.isDeleted=!0,ce.includes(r.type)&&r.boundElement.forEach(s=>{console.log(s,this.data),this.data.find(n=>n.id===s.id).isDeleted=!0}))}),this.data=this.data.filter(r=>r.isDeleted?(t.push(ne(N({},r),{isSelected:!1,isDeleted:!1})),!1):!0),this.addOperateStack({type:"DELETE",payload:t}),this.storageDrawData()}}F=new WeakMap,ue=new WeakSet,Pt=function(){let t;try{t=JSON.parse(localStorage.getItem(xe))||[]}catch{t=[],localStorage.setItem(xe,"[]")}return t};var c=new Ct;const We=()=>document.querySelector("textarea")?null:document.createElement("textarea"),He=(e,t)=>{Object.assign(e.style,N({position:"absolute",margin:0,padding:0,border:0,outline:0,background:"transparent",resize:"none",fontSize:k+"px",lineHeight:"1em",fontFamily:Ne,overflow:"hidden"},t))},Fe=(e,{oninput:t,onChange:r})=>{e.onkeydown=s=>{s.stopPropagation()},e.oninput=()=>{e.style.height=e.scrollHeight+"px",t==null||t()},e.onblur=s=>{r(s.target.value),document.body.removeChild(e)},setTimeout(()=>{e.focus()})},Nt=(e,t,r)=>{const s=We();if(!s)return;if(He(s,{top:e.y+e.height/2-De+"px",left:e.x+"px",width:e.width+"px",height:De+"px",textAlign:"center"}),r){const o=r.content;s.value=o,s.setSelectionRange(0,o.length),s.style.height=r.height+"px",s.style.top=e.y+e.height/2-r.height/2+"px"}const n=()=>{const[o]=Ue(s.value,e.width);return o.length};Fe(s,{oninput:()=>{const o=n();s.style.height=o*De+"px",s.style.top=e.y+e.height/2-o*k/2+"px"},onChange:o=>{t(o,k*n())}}),document.body.appendChild(s)},kt=({x:e,y:t},r,s)=>{const n=We();if(!!n){if(s){const o=s.content;n.value=o,n.setSelectionRange(0,o.length),n.style.height=s.height+"px"}He(n,{top:t+"px",left:e+"px",width:`${window.innerWidth-e}px`,whiteSpace:"nowrap"}),Fe(n,{onChange:r}),document.body.appendChild(n)}},R=5,Xt=e=>e>R?e-R:0,le=e=>e+R<window.innerWidth?e+R:window.innerWidth,de=e=>e+R<window.innerWidth?e+R:window.innerWidth,Y=(e,t,r)=>e>=Xt(t)&&e<=r,Ee=(e,t,r,s)=>Math.pow(Math.pow(Math.abs(e-t),2)+Math.pow(Math.abs(r-s),2),1/2),Yt=({x:e,y:t})=>{const r=c.data.filter(s=>ce.includes(s.type)&&s.boundElement.length!==0);for(let s=0;s<r.length;s++){const n=r[s];if(n.type==="rectangle"&&e>=n.x-R&&e<=n.x+n.width+R&&t>=n.y-R&&t<=n.y+n.height+R)return n.id;if(n.type==="diamond"){const o=n.width*n.height,a=Math.abs(e-(n.x+n.width/2)),f=Math.abs(t-(n.y+n.height/2)),i=((a+R)*n.height+(f+R)*n.width)*2;if(e>=n.x-R&&e<=n.x+n.width+R&&t>=n.y-R&&t<=n.y+n.height+R&&i<=o)return n.id}if(n.type==="circle"){const o=n.x+n.width/2,a=n.y+n.height/2,f=n.width/2,i=n.height/2;if(Math.pow(e-o,2)/Math.pow(f,2)+Math.pow(t-a,2)/Math.pow(i,2)<=1)return n.id}}return null},Se=({x:e,y:t})=>{for(let s=0;s<c.data.length;s++){const n=c.data[s];if(n.type==="text"&&n.containerId!==null)continue;const o=n.x,a=n.x+n.width,f=n.y,i=n.y+n.height;if(n.isSelected){const g=n.width>0?a:o,x=n.width>0?o:a,T=n.height>0?i:f,D=n.height>0?f:i;if(e>=x&&e<=g&&t>=D&&t<=T)return n.id}if(n.type==="text"&&Y(e,o,le(a))&&Y(t,f,de(i))||n.type==="rectangle"&&((Y(e,o,le(o))||Y(e,a,le(a)))&&Y(t,f,de(i))||(Y(t,f,de(f))||Y(t,i,de(i)))&&Y(e,o,le(a))))return n.id;if(n.type==="diamond"){const g=n.width*n.height,x=Math.abs(e-(o+n.width/2)),T=Math.abs(t-(f+n.height/2)),D=((x+R)*n.height+(T+R)*n.width)*2,A=((x-R)*n.height+(T-R)*n.width)*2;if(D>=g&&A<=g)return n.id}if(n.type==="circle"){const g=o+n.width/2,x=f+n.height/2,T=n.width/2,D=n.height/2,A=Math.pow(e-g,2)/Math.pow(T,2)+Math.pow(t-x,2)/Math.pow(D,2);if(A<=1.1&&A>=.9)return n.id}if(n.type==="arrow"){const g=Math.round(Ee(o,a,f,i)),x=Math.round(Ee(e,o,t,f)+Ee(e,a,t,i));if(x>=g-R/2&&x<=g+R/2)return n.id}}const r=Yt({x:e,y:t});return r||null},Wt=(e,t,r,s)=>{const[n,o]=r>0?[e+r,e]:[e,e+r],[a,f]=s>0?[t+s,t]:[t,t+s];return c.data.filter(i=>{if(i.type==="selection"||i.type==="text"&&i.containerId!==null)return!1;const[g,x]=i.width>0?[i.x+i.width,i.x]:[i.x,i.x+i.width],[T,D]=i.height>0?[i.y+i.height,i.y]:[i.y,i.y+i.height];return n>=g&&o<=x&&a>=T&&f<=D}).map(({id:i})=>i)},Be=(e,t)=>{const r=c.getSelectionData();if(!r)return!1;const[s,n,o,a]=r;return e<=s&&e>=n&&t<=o&&t>=a},S=(e,t,r)=>r?e>=t+X&&e<=t+B+X:e<=t-X&&e>=t-B-X,Ge=({x:e,y:t})=>{const r=c.getSelectionData();if(!r)return null;const[s,n,o,a,f]=r;if(f){if(s>=n&&o>a){if(S(e,n,!1)&&S(t,a,!1))return[v.nwseResize,"top"];if(S(e,s,!0)&&S(t,o,!0))return[v.nwseResize,"bottom"]}else if(s>=n&&o<a){if(S(e,n,!1)&&S(t,a,!0))return[v.neswResize,"bottom"];if(S(e,s,!0)&&S(t,o,!1))return[v.neswResize,"top"]}else if(s<n&&o>a){if(S(e,n,!0)&&S(t,a,!1))return[v.neswResize,"top"];if(S(e,s,!1)&&S(t,o,!0))return[v.neswResize,"bottom"]}else{if(S(e,s,!1)&&S(t,o,!1))return[v.nwseResize,"top"];if(S(e,n,!0)&&S(t,a,!0))return[v.nwseResize,"bottom"]}return null}return S(e,n,!1)&&S(t,a,!1)?[v.nwseResize,"top"]:S(e,s,!0)&&S(t,o,!0)?[v.nwseResize,"bottom"]:S(e,n,!1)&&S(t,o,!0)?[v.neswResize,"bottom"]:S(e,s,!0)&&S(t,a,!1)?[v.neswResize,"top"]:null},Ht=({x:e,y:t})=>{const r=c.data.filter(s=>s.type==="text");for(let s=0;s<r.length;s++){const n=r[s];if(e>=n.x&&e<=n.x+n.width&&t>=n.y&&t<=n.y+n.height)return n}return null},Re=e=>{let t=-1/0,r=-1/0,s=1/0,n=1/0;return e.forEach(o=>{const[a,f]=o.width>0?[o.x+o.width,o.x]:[o.x,o.x+o.width],[i,g]=o.height>0?[o.y+o.height,o.y]:[o.y,o.y+o.height];a>t&&(t=a),i>r&&(r=i),f<s&&(s=f),g<n&&(n=g)}),[t,s,r,n]},Ft=({x:e,y:t})=>{let r=null;return c.data.forEach(s=>{const n=s.x+s.width/2,o=s.y+s.height/2;ce.includes(s.type)&&e<=n+ie&&e>=n-ie&&t<=o+ie&&t>=o-ie&&(r?s.width<r.width&&(r=s):r=s)}),r},be=e=>e.replace(/\r\n?/g,`
`).split(`
`),Bt=e=>{const t="\uFEFF",r=new Blob([t+e],{type:"text/json"});return URL.createObjectURL(r)},Ue=(e,t,r)=>{const s=r!=null?r:document.createElement("canvas").getContext("2d"),n=[];be(e).forEach(f=>{let i="",g=0;for(let x=1;x<=f.length;x++){i=f.substring(g,x);const{width:T}=s.measureText(i);T>t&&(n.push(f.substring(g,x-1)),g=x-1)}n.push(i)});let a=0;return n.forEach(f=>{const{width:i}=s.measureText(f);i>a&&(a=i)}),[n,a]},je=(e,t)=>{const r=document.createElement("a");r.download=t,r.href=e,document.body.appendChild(r),r.click(),document.body.removeChild(r)};var C=ht();const Gt="_container_1dwzc_1",Ut="_element_1dwzc_10",jt="_operate_1dwzc_14",Jt="_active_1dwzc_30";var W={container:Gt,element:Ut,operate:jt,"tool-item":"_tool-item_1dwzc_17",active:Jt,"tool-index":"_tool-index_1dwzc_33"};const Kt=({Icon:e,index:t,changeType:r,isActive:s})=>se("div",{className:we(W["tool-item"],{[W.active]:s}),onClick:r,children:[M("div",{children:e}),M("div",{className:W["tool-index"],children:t})]}),Vt=(e,t)=>{w.exports.useEffect(()=>{const r=()=>{!e.current||!t.current||(e.current.width=window.innerWidth,e.current.height=window.innerHeight,Te(t.current))};return r(),window.addEventListener("resize",r),()=>document.removeEventListener("resize",r)},[])},Je=e=>{w.exports.useEffect(()=>{const t=r=>{const{key:s,metaKey:n}=r;e(s,n)};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[])},Le=w.exports.createContext({}),Zt=({children:e})=>{const[t,r]=w.exports.useState("selection");return M(Le.Provider,{value:{drawType:t,setDrawType:r},children:e})},ve=w.exports.createContext({}),$t=({children:e})=>{const[t,r]=w.exports.useState(v.default);return M(ve.Provider,{value:{cursorType:t,setCursorType:r},children:e})},qt=e=>{const{drawType:t,setDrawType:r}=w.exports.useContext(Le),{cursorType:s,setCursorType:n}=w.exports.useContext(ve),o=w.exports.useRef(!1),a=w.exports.useRef(!1),f=w.exports.useRef(!1),i=w.exports.useRef(!1),g=w.exports.useRef(),x=w.exports.useRef(),T=w.exports.useRef(),D=w.exports.useRef({x:0,y:0}),A=w.exports.useRef({x:0,y:0}),I=w.exports.useRef({x:0,y:0}),G=w.exports.useRef([]),K=w.exports.useRef([]),he=w.exports.useRef({x:0,y:0}),V=w.exports.useRef(!1),O=()=>{e.current&&(e.current.clearRect(0,0,window.innerWidth,window.innerHeight),Te(e.current))},U=()=>{c.data.forEach(d=>d.isSelected=!1)};w.exports.useEffect(()=>{const d=()=>{c.addOperateStack({type:"DELETE",payload:c.data}),c.data=[],c.storageDrawData(),O()},u=()=>{if(c.data.length===0)return;const p=document.createElement("canvas"),[y,m,E,b]=Re(c.data),L=y-m+ae,z=E-b+ae;p.width=L,p.height=z;const _=p.getContext("2d");_.save(),_.fillStyle=Tt,_.fillRect(0,0,L,z),_.restore(),Te(_,c.data.map(j=>ne(N({},j),{x:j.x-m+ae/2,y:j.y-b+ae/2})));const H=p.toDataURL();je(H,Rt)},l=()=>{if(c.data.length===0)return;const p=Bt(JSON.stringify(c.data));je(p,bt)},h=()=>{const p=document.createElement("input");p.type="file",document.body.appendChild(p),p.click(),p.onchange=y=>{const E=y.target.files[0],b=new FileReader;b.onload=L=>{try{const z=JSON.parse(L.target.result);c.addOperateStack({type:"SET",payload:c.data}),c.data=z,c.storageDrawData(),O()}catch{}},b.readAsText(E),document.body.removeChild(p)}};return C.on("exportImage",u),C.on("exportData",l),C.on("clear",d),C.on("import",h),()=>{C.off("import",h),C.off("exportData",l),C.off("exportImage",u),C.off("clear",d)}},[]),w.exports.useEffect(()=>{const d=()=>{K.current=c.data.filter(l=>l.isSelected)},u=()=>{if(K.current.length>0&&!V.current){const[l,h,p,y]=Re(K.current),[m,E]=[(l+h)/2,(p+y)/2],[b,L]=[he.current.x-m,he.current.y-E];U();const z=[];K.current.forEach(_=>{const H=oe();c.addDrawData(ne(N({},_),{id:H,x:_.x+b,y:_.y+L,isSelected:!0})),z.push(H)}),c.addOperateStack({type:"ADD",selectedIds:z}),c.storageDrawData(),O()}};return document.addEventListener("copy",d),document.addEventListener("paste",u),()=>{document.removeEventListener("copy",d),document.addEventListener("paste",u)}},[]);const Ke=(d,u,l)=>{d.type==="arrow"?x.current==="head"?(d.width+=u,d.height+=l):(d.x+=u,d.y+=l,d.width-=u,d.height-=l):s==="nesw-resize"?g.current==="top"?(d.y+=l,d.width+=u,d.height-=l):(d.height+=l,d.x+=u,d.width-=u):s==="nwse-resize"&&(g.current==="top"?(d.x+=u,d.y+=l,d.width-=u,d.height-=l):(d.width+=u,d.height+=l))},Ve=(d,u,l)=>{const{x:h,y:p}=A.current,y={x:0,y:0},m=u-h,E=l-p,b=c.getSelectionData(),L=b[0]-b[1],z=b[2]-b[3],_=g.current==="top",H=_&&s==="nesw-resize"||g.current==="bottom"&&s==="nwse-resize",j=g.current==="bottom"&&s==="nesw-resize"||_&&s==="nwse-resize";if(L<=ke&&(m<=I.current.x&&H||m>=I.current.x&&j)||z<=ke&&(E<=I.current.y&&g.current==="bottom"||E>=I.current.y&&_))return;let ee=0,te=0;const Ie=Math.abs(m)>Math.abs(E);ee=Ie?s==="nesw-resize"?-E:E:m,te=Ie?E:s==="nesw-resize"?-m:m,y.x=b[H?1:0],y.y=b[_?2:3],d.forEach(P=>{const Ae=Math.abs(P.x-y.x)/L,Qe=Math.abs(P.x+P.width-y.x)/L,Me=Math.abs(P.y-y.y)/z,et=Math.abs(P.y+P.height-y.y)/z;P.x+=(ee-I.current.x)*Ae,P.y+=(te-I.current.y)*Me,P.type!=="text"&&(P.width+=(ee-I.current.x)*(Qe-Ae),P.height+=(te-I.current.y)*(et-Me))}),I.current={x:ee,y:te}},Ze=(d,u,l)=>{d.length===1?Ke(d[0],u-D.current.x,l-D.current.y):Ve(d,u,l)},$e=(d,u,l)=>{d.forEach(h=>{h.x+=u,h.y+=l})},fe=(d,u,l)=>{V.current=!0;const h=u?c.data.find(y=>y.id===u):Ft(d),p=oe();h?Nt(h,(y,m)=>{if(V.current=!1,y.trim()&&e.current){const[E,b]=Ue(y,h.width,e.current),L=h.y+h.height/2-m/2;c.addDrawData({type:"text",id:p,x:h.x+(h.width-b)/2,y:L,content:E.join(`
`),width:b,height:m,isSelected:!1,isDeleted:!1,containerId:h.id}),h.boundElement.push({type:"text",id:p}),c.addOperateStack({type:"ADD",selectedIds:[p]}),c.storageDrawData(),O()}},l):kt(d,y=>{if(V.current=!1,y.trim()){const m=be(y);let E=0;m.forEach(b=>{if(e.current){const{width:L}=e.current.measureText(b);L>E&&(E=L)}}),c.addDrawData({type:"text",id:p,x:d.x,y:d.y,content:y,width:E,height:m.length*k,isSelected:!1,isDeleted:!1,containerId:null}),c.addOperateStack({type:"ADD",selectedIds:[p]}),c.storageDrawData(),O()}},l)},Z=w.exports.useRef();Z.current=(d,u)=>{if(t==="selection"){const l=Ht({x:d,y:u});if(U(),l){if(c.data=c.data.filter(h=>h.id!==l.id),l.containerId){const h=c.data.find(p=>p.id===l.containerId);h.boundElement=h.boundElement.filter(p=>p.id!==l.id)}fe({x:l.x,y:l.y},l.containerId,l)}else fe({x:d,y:u},null);O()}},w.exports.useEffect(()=>{const d=({pageX:u,pageY:l})=>{var h;(h=Z.current)==null||h.call(Z,u,l)};return document.addEventListener("dblclick",d),()=>document.removeEventListener("dblclick",d)},[]),w.exports.useEffect(()=>{n(t==="selection"?v.default:v.crosshair),t!=="selection"&&U()},[t]),Je((d,u)=>{u&&d==="z"&&(c.revokeDrawData(),O()),u&&d==="a"&&(c.data.forEach(l=>l.isSelected=!0),c.data.length>1&&(i.current=!0),c.storageDrawData(),O()),d==="Backspace"&&(c.delete(),O())});const qe=()=>{T.current=void 0,f.current=!1,I.current={x:0,y:0},G.current=[]},$=w.exports.useRef();$.current=d=>{if(d.button===2)return;const{pageX:u,pageY:l}=d;if(D.current=A.current={x:u,y:l},t==="text")r("selection"),fe({x:u,y:l},null);else if(t==="selection"){if(o.current=!0,i.current&&Be(u,l)){a.current=!0;return}const h=Ge({x:u,y:l});if(h){g.current=h[1],a.current=!0;const y=c.data.filter(m=>m.isSelected);if(G.current=y.map(m=>N({},m)),y.length===1&&y[0].type==="arrow"){const m=y[0];x.current=m.height<=0&&g.current==="top"||m.height>0&&g.current==="bottom"?"head":"foot"}return}const p=Se({x:u,y:l});U(),a.current=!1,p?(c.data.find(y=>y.id===p).isSelected=!0,a.current=!0,c.storageDrawData()):(c.addDrawData({type:t,id:oe(),x:u,y:l,width:0,height:0,isSelected:!1,isDeleted:!1}),O())}else o.current=!0,c.addDrawData({type:t,id:oe(),x:u,y:l,width:0,height:0,isSelected:!1,isDeleted:!1,boundElement:[]})};const q=w.exports.useRef();q.current=d=>{const{pageX:u,pageY:l}=d;if(he.current={x:u,y:l},!o.current){const y=Ge({x:u,y:l});if(y){n(y[0]);return}if(t==="selection"){const m=i.current?Be(u,l):Se({x:u,y:l});n(m?v.move:v.default)}return}const h=u-D.current.x,p=l-D.current.y;if(t==="selection"&&a.current){const y=c.data.filter(E=>E.isSelected);y.forEach(E=>{ce.includes(E.type)&&E.boundElement.filter(L=>L.type==="text").forEach(L=>{y.push(c.data.find(z=>z.id===L.id))})});const m=["nesw-resize","nwse-resize"].includes(s);m?Ze(y,u,l):$e(y,h,p),(u!==D.current.x||l!==D.current.y)&&(T.current=m?"resize":"move",D.current={x:u,y:l})}else{const y=c.data[c.data.length-1];if(y.type!=="text"&&(y.width=h,y.height=p),y.type==="selection"){f.current=!0;const m=Wt(D.current.x,D.current.y,h,p);i.current=m.length>1,c.data.forEach(E=>{E.isSelected=m.includes(E.id)})}}O()};const Q=w.exports.useRef();Q.current=d=>{if(!o.current)return;o.current=!1;const{pageX:u,pageY:l}=d;if(u===D.current.x&&l===D.current.y)t!=="selection"&&c.popDrawData(),T.current?T.current==="move"?c.addOperateStack({type:"MOVE",selectedIds:c.data.filter(h=>h.isSelected).map(h=>h.id),payload:{x:u-A.current.x,y:l-A.current.y}}):c.addOperateStack({type:"RESIZE",payload:G.current}):i.current=!1;else{if(t!=="selection"){const h=c.data[c.data.length-1];h.isSelected=!0,c.addOperateStack({type:"ADD",selectedIds:[h.id]}),r("selection")}else c.popDrawData();O()}if(t==="selection"&&!T.current&&!f.current){U();const h=Se({x:u,y:l});h?c.data.find(p=>p.id===h).isSelected=!0:n(v.default),O()}qe(),c.storageDrawData()},w.exports.useEffect(()=>{const d=h=>{var p;(p=q.current)==null||p.call(q,h)},u=h=>{var p;(p=$.current)==null||p.call($,h)},l=h=>{var p;(p=Q.current)==null||p.call(Q,h)};return document.addEventListener("mousedown",u),document.addEventListener("mousemove",d),document.addEventListener("mouseup",l),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",l)}},[])},Qt=()=>{const{drawType:e,setDrawType:t}=w.exports.useContext(Le);Je(f=>{const i=+f-1;!isNaN(i)&&i!==-1&&i<me.length&&t(me[i].type)});const r=(f,i)=>M("div",{className:W["tool-item"],onClick:i,children:M(f,N({},Pe))}),s=()=>{C.emit("clear")},n=()=>{C.emit("import")},o=()=>{C.emit("exportData")},a=()=>{C.emit("exportImage")};return se(ft,{children:[M("div",{className:we(W.container,W.element),children:me.map(({Icon:f,type:i},g)=>M(Kt,{isActive:i===e,Icon:M(f,N({},Pe)),index:g+1,changeType:()=>t(i)},g))}),se("div",{className:we(W.container,W.operate),children:[r(wt,s),r(pt,n),r(gt,o),r(yt,a)]})]})};function en(){const e=w.exports.useRef(null),t=w.exports.useRef(null),{cursorType:r}=w.exports.useContext(ve);return w.exports.useEffect(()=>{e.current&&(t.current=e.current.getContext("2d"))},[]),qt(t),Vt(e,t),se("div",{className:"App",style:{position:"relative",cursor:r},children:[M(Qt,{}),M("canvas",{ref:e,id:"canvas"})]})}mt.render(M(xt.StrictMode,{children:M(Zt,{children:M($t,{children:M(en,{})})})}),document.getElementById("root"));
